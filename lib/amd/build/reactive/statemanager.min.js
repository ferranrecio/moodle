define ("core/reactive/statemanager",["exports","core/utils"],function(a,b){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=void 0;function c(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){c=function(a){return typeof a}}else{c=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return c(a)}function d(a,b,c){if("undefined"!=typeof Reflect&&Reflect.get){d=Reflect.get}else{d=function(a,b,c){var d=e(a,b);if(!d)return;var f=Object.getOwnPropertyDescriptor(d,b);if(f.get){return f.get.call(c)}return f.value}}return d(a,b,c||a)}function e(a,b){while(!Object.prototype.hasOwnProperty.call(a,b)){a=p(a);if(null===a)break}return a}function f(a,b){if("function"!=typeof b&&null!==b){throw new TypeError("Super expression must either be null or a function")}a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}});if(b)n(a,b)}function g(a){return function(){var b=p(a),c;if(l()){var d=p(this).constructor;c=Reflect.construct(b,arguments,d)}else{c=b.apply(this,arguments)}return h(this,c)}}function h(a,b){if(b&&("object"===c(b)||"function"==typeof b)){return b}return i(a)}function i(a){if(void 0===a){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return a}function j(a){var b="function"==typeof Map?new Map:void 0;j=function(a){if(null===a||!m(a))return a;if("function"!=typeof a){throw new TypeError("Super expression must either be null or a function")}if("undefined"!=typeof b){if(b.has(a))return b.get(a);b.set(a,c)}function c(){return k(a,arguments,p(this).constructor)}c.prototype=Object.create(a.prototype,{constructor:{value:c,enumerable:!1,writable:!0,configurable:!0}});return n(c,a)};return j(a)}function k(){if(l()){k=Reflect.construct}else{k=function(b,c,d){var e=[null];e.push.apply(e,c);var a=Function.bind.apply(b,e),f=new a;if(d)n(f,d.prototype);return f}}return k.apply(null,arguments)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return!0}catch(a){return!1}}function m(a){return-1!==Function.toString.call(a).indexOf("[native code]")}function n(a,b){n=Object.setPrototypeOf||function(a,b){a.__proto__=b;return a};return n(a,b)}function p(a){p=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)};return p(a)}function q(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function r(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function s(a,b,c){if(b)r(a.prototype,b);if(c)r(a,c);return a}var t=function(){function a(c,d){var e=this;q(this,a);this.dispatchEvent=c;this.target=null!==d&&void 0!==d?d:document;this.locked=!1;this.eventstopublish=[];this.initialPromise=new Promise(function(a){e.target.addEventListener("state:loaded",function initialStateDone(b){a(b.detail.state)})});this.publishEvents=(0,b.debounce)(this._publishEvents,10)}s(a,[{key:"setInitialState",value:function setInitialState(a){if(this.state!==void 0){throw Error("Initial state can only be initialized ones")}var b=new Proxy({},u("state",this,!0));for(var c in a){if(a.hasOwnProperty(c)){b[c]=a[c]}}this.state=b;this.locked=!0;this.dispatchEvent({action:"state:loaded",state:this.state},this.target)}},{key:"getInitialPromise",value:function getInitialPromise(){return this.initialPromise}},{key:"setLocked",value:function setLocked(a){this.locked=a}},{key:"processUpdates",value:function processUpdates(a){var b=this;this.locked=!1;if(!Array.isArray(a)){throw Error("State updates must be an array")}a.forEach(function(a){if(a.name===void 0){throw Error("Missing state update name")}b.processUpdate(a.name,a.action,a.fields)});this.locked=!0}},{key:"processUpdate",value:function processUpdate(a,b,c){var d=this.state;if(!c){throw Error("Missing state update fields")}if("create"==b){if(d[a]instanceof v){d[a].add(c);return}d[a]=c;return}var e=d[a];if(e instanceof v){if(c.id===void 0){throw Error("Missing id for ".concat(a," state update"))}e=d[a].get(c.id);if(!e){throw Error("Inexistent ".concat(a," ").concat(c.id))}}if("delete"==b){if(d[a]instanceof v){d[a].delete(c.id);return}delete d[a];return}if("update"==b||b===void 0){for(var f in c){if(c.hasOwnProperty(f)){e[f]=c[f]}}}}},{key:"_publishEvents",value:function _publishEvents(){var a=this,b=this.eventstopublish;this.eventstopublish=[];b.sort(function(c,a){var b,d,e={created:0,updated:1,deleted:2},f=null!==(b=e[c.action])&&void 0!==b?b:0,g=null!==(d=e[a.action])&&void 0!==d?d:0;if(f===g){return a.eventname.length-c.eventname.length}return f-g});var c=new Set;b.forEach(function(b){var d,e="".concat(b.eventname,".").concat(null!==(d=b.eventdata.id)&&void 0!==d?d:0);if(!c.has(e)){a.dispatchEvent({action:b.eventname,state:a.state,element:b.eventdata},a.target);c.add(e)}})}}]);return a}();a.default=t;var u=function(a,b,c){var d;c=null!==(d=c)&&void 0!==d?d:!1;return{name:a,statemanager:b,proxyvalues:c,set:function set(a,b,c,d){if(this.statemanager.locked){throw new Error("State locked. Use mutations to change ".concat(b," value in ").concat(this.name,"."))}if(JSON.stringify(a[b])===JSON.stringify(c)){return!0}var e=a[b]!==void 0?"updated":"created";if(this.proxyvalues){if(Array.isArray(c)){a[b]=new v(b,this.statemanager).loadValues(c)}else{a[b]=new Proxy(c,u(b,this.statemanager))}}else{a[b]=c}if(this.statemanager.state===void 0){return!0}this.statemanager.eventstopublish.push({eventname:"".concat(this.name,".").concat(b,":").concat(e),eventdata:d,action:e});if(a.id!==void 0){this.statemanager.eventstopublish.push({eventname:"".concat(this.name,"[").concat(a.id,"].").concat(b,":").concat(e),eventdata:d,action:e});this.statemanager.eventstopublish.push({eventname:"".concat(this.name,"[").concat(a.id,"]:").concat(e),eventdata:d,action:e})}this.statemanager.eventstopublish.push({eventname:"".concat(this.name,":updated"),eventdata:d,action:"updated"});this.statemanager.publishEvents(this.statemanager);return!0},deleteProperty:function deleteProperty(a,b){if(this.statemanager.locked){throw new Error("State locked. Use mutations to delete ".concat(b," in ").concat(this.name,"."))}if(b in a){delete a[b];this.statemanager.eventstopublish.push({eventname:"".concat(this.name,".").concat(b,":deleted"),eventdata:a,action:"deleted"});if(a.id!==void 0){this.statemanager.eventstopublish.push({eventname:"".concat(this.name,"[").concat(a.id,"].").concat(b,":deleted"),eventdata:a,action:"deleted"});this.statemanager.eventstopublish.push({eventname:"".concat(this.name,"[").concat(a.id,"]:updated"),eventdata:a,action:"updated"})}this.statemanager.eventstopublish.push({eventname:"".concat(this.name,":updated"),eventdata:a,action:"updated"});this.statemanager.publishEvents(this.statemanager)}return!0}}},v=function(a){f(b,a);var e=g(b);function b(a,c,d){var f;q(this,b);f=e.call(this,d);f.name=a;f.statemanager=c;return f}s(b,[{key:"set",value:function set(a,c){if(this.statemanager.locked){throw new Error("State locked. Use mutations to change ".concat(a," value in ").concat(this.name,"."))}this.checkValue(c);if(a===void 0||null===a){throw Error("State lists keys cannot be null or undefined")}if(c.id!==a){throw new Error("State error: ".concat(this.name," list element ID (").concat(c.id,") and key (").concat(a,") mismatch"))}var e=d(p(b.prototype),"has",this).call(this,a)?"updated":"created",f=d(p(b.prototype),"set",this).call(this,a,new Proxy(c,u(this.name,this.statemanager)));if(this.statemanager.state===void 0){return f}this.statemanager.eventstopublish.push({eventname:"".concat(this.name,"[").concat(c.id,"]:").concat(e),eventdata:d(p(b.prototype),"get",this).call(this,a),action:e});this.statemanager.eventstopublish.push({eventname:"".concat(this.name,":").concat(e),eventdata:d(p(b.prototype),"get",this).call(this,a),action:e});this.statemanager.publishEvents(this.statemanager);return f}},{key:"checkValue",value:function checkValue(a){if("object"===!c(a)&&null!==a){throw Error("State lists can contain objects only")}if(a.id===void 0){throw Error("State lists elements must contains at least an id attribute")}}},{key:"add",value:function add(a){this.checkValue(a);return this.set(a.id,a)}},{key:"delete",value:function _delete(a){if(this.statemanager.locked){throw new Error("State locked. Use mutations to change ".concat(a," value in ").concat(this.name,"."))}var c=d(p(b.prototype),"get",this).call(this,a),e=d(p(b.prototype),"delete",this).call(this,a);if(!e){return e}this.statemanager.eventstopublish.push({eventname:"".concat(this.name,"[").concat(a,"]:deleted"),eventdata:c,action:"deleted"});this.statemanager.eventstopublish.push({eventname:"".concat(this.name,":deleted"),eventdata:c,action:"deleted"});this.statemanager.publishEvents(this.statemanager);return e}},{key:"toJSON",value:function toJSON(){var a=[];this.forEach(function(b){a.push(b)});return a}},{key:"loadValues",value:function loadValues(a){var b=this;a.forEach(function(a){b.checkValue(a);var c=a.id,d=new Proxy(a,u(b.name,b.statemanager));b.set(c,d)});return this}}]);return b}(j(Map));return a.default});
//# sourceMappingURL=statemanager.min.js.map
