define("core/local/reactive/virtualdom",["exports","core/templates"],(function(_exports,_templates){var obj;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_templates=(obj=_templates)&&obj.__esModule?obj:{default:obj};const protectecAttributes=["data-mdl-component-hash","data-mdl-refresh"];
/**
   * Basic VirtualDOM differ for reactive components.
   *
   * This code is loosely based on the following articles:
   * https://dev.to/joydeep-bhowmik/virtual-dom-diffing-algorithm-implementation-in-vanilla-javascript-2324
   * https://dev.to/joydeep-bhowmik/adding-keys-our-dom-diffing-algorithm-4d7g
   *
   * @module     core/local/reactive/virtualdom
   * @copyright  2024 Ferran Recio <ferran@moodle.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */return _exports.default=class{constructor(component){this.component=component,this.keyIndex=null}static applyTemplate(component,html,js){new this(component)._applyVirtualDomFromTemplate(html,js)}static applyHTMLElement(component,vdom){new this(component)._applyVirtualDomFromElement(vdom)}_applyVirtualDomFromTemplate(newContent,newJs){const vdom=this._parseHTML(newContent);this._applyVirtualDomFromElement(vdom),void 0!==newJs&&_templates.default.runTemplateJS(newJs)}_applyVirtualDomFromElement(vdom){const dom=this.component.getElement();this.keyIndex=this._getKeyElementsIndex(vdom,dom),this._diff(vdom,dom)}_getKeyElementsIndex(vdom,dom){const result=new Map;return vdom.querySelectorAll("[data-mdl-key]").forEach((element=>{const key=element.getAttribute("data-mdl-key"),newElement=dom.querySelector('[data-mdl-key="'.concat(key,'"]'));if(!newElement)return;newElement.closest("[data-mdl-component-hash]").getAttribute("data-mdl-component-hash")==this.component.getComponentHash()&&result.set(key,newElement)})),result}_diff(vdom,dom){if(this._needsToDiffed(vdom,dom))if(!1!==dom.hasChildNodes()||!0!==vdom.hasChildNodes())this._diffChilds(vdom,dom);else for(let i=0;i<vdom.childNodes.length;i++)dom.append(vdom.childNodes[i].cloneNode(!0))}_needsToDiffed(vdom,dom){if("static"===dom.getAttribute("data-mdl-refresh"))return!1;if("inject"===dom.getAttribute("data-mdl-refresh"))return!0;if(dom.hasAttribute("data-mdl-component-hash")&&dom.getAttribute("data-mdl-component-hash")!==this.component.getComponentHash()){const subcomponent=this.component.getElementComponent(dom);return subcomponent&&subcomponent.allowTemplateInjection()&&subcomponent.injectContent(vdom),!1}return!vdom.isEqualNode(dom)}_sortChildKeyElements(vdom,dom){if(null!==vdom.querySelector(":scope > [data-mdl-key]"))for(let i=0;i<vdom.childNodes.length;i++){const key=vdom.childNodes[i].getAttribute("data-mdl-key");if(!key||!this.keyIndex.has(key))continue;const newElement=this.keyIndex.get(key);dom.insertBefore(newElement,dom.childNodes[i])}}_removeUnnecessaryChilds(vdom,dom){if(dom.childNodes.length>vdom.childNodes.length){let count=dom.childNodes.length-vdom.childNodes.length;if(count>0)for(;count>0;count--)dom.lastChild.remove()}}_diffChilds(vdom,dom){this._sortChildKeyElements(vdom,dom),this._removeUnnecessaryChilds(vdom,dom);for(let i=0;i<vdom.childNodes.length;i++)void 0===dom.childNodes[i]?dom.append(vdom.childNodes[i].cloneNode(!0)):this._diffElement(vdom.childNodes[i],dom.childNodes[i]),vdom.childNodes[i].nodeType!==Node.TEXT_NODE&&this._diff(vdom.childNodes[i],dom.childNodes[i])}_diffElement(vdomNode,domNode){this._getNodeType(vdomNode)===this._getNodeType(domNode)?vdomNode.nodeType===Node.TEXT_NODE?vdomNode.textContent!==domNode.textContent&&(domNode.textContent=vdomNode.textContent):this._patchAttributes(vdomNode,domNode):domNode.replaceWith(vdomNode.cloneNode(!0))}_getNodeType(node){return node.nodeType==Node.ELEMENT_NODE?node.tagName.toLowerCase():node.nodeType}_patchAttributes(vdom,dom){let vdomAttributes=this._attributesIndex(vdom),domAttributes=this._attributesIndex(dom);vdomAttributes!=domAttributes&&(Object.keys(vdomAttributes).forEach((key=>{dom.getAttribute(key)?dom.getAttribute(key)&&vdomAttributes[key]!=domAttributes[key]&&dom.setAttribute(key,vdomAttributes[key]):dom.setAttribute(key,vdomAttributes[key])})),Object.keys(domAttributes).forEach((key=>{vdom.getAttribute(key)||protectecAttributes.includes(key)||dom.removeAttribute(key)})))}_attributesIndex(element){var attributes={};if(null==element.attributes)return attributes;for(var i=0,atts=element.attributes,n=atts.length;i<n;i++)attributes[atts[i].name]=atts[i].value;return attributes}_parseHTML(html){let doc=(new DOMParser).parseFromString(html,"text/html");if(this._clean(doc.body),1!=doc.body.childElementCount)throw new Error("The HTML must have only one root element");return doc.body.firstChild}_clean(node){for(let n=0;n<node.childNodes.length;n++){const child=node.childNodes[n];child.nodeType===Node.COMMENT_NODE||child.nodeType===Node.TEXT_NODE&&!/\S/.test(child.nodeValue)&&child.nodeValue.includes("\n")?(node.removeChild(child),n--):child.nodeType===Node.ELEMENT_NODE&&this._clean(child)}}},_exports.default}));

//# sourceMappingURL=virtualdom.min.js.map