define ("core/local/reactive/statemanager",["exports"],function(a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=void 0;function b(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){b=function(a){return typeof a}}else{b=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return b(a)}function c(a,b,e){if("undefined"!=typeof Reflect&&Reflect.get){c=Reflect.get}else{c=function(a,b,c){var e=d(a,b);if(!e)return;var f=Object.getOwnPropertyDescriptor(e,b);if(f.get){return f.get.call(c)}return f.value}}return c(a,b,e||a)}function d(a,b){while(!Object.prototype.hasOwnProperty.call(a,b)){a=n(a);if(null===a)break}return a}function e(a,b){if("function"!=typeof b&&null!==b){throw new TypeError("Super expression must either be null or a function")}a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}});if(b)m(a,b)}function f(a){return function(){var b=n(a),c;if(k()){var d=n(this).constructor;c=Reflect.construct(b,arguments,d)}else{c=b.apply(this,arguments)}return g(this,c)}}function g(a,c){if(c&&("object"===b(c)||"function"==typeof c)){return c}return h(a)}function h(a){if(void 0===a){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return a}function i(a){var b="function"==typeof Map?new Map:void 0;i=function(a){if(null===a||!l(a))return a;if("function"!=typeof a){throw new TypeError("Super expression must either be null or a function")}if("undefined"!=typeof b){if(b.has(a))return b.get(a);b.set(a,c)}function c(){return j(a,arguments,n(this).constructor)}c.prototype=Object.create(a.prototype,{constructor:{value:c,enumerable:!1,writable:!0,configurable:!0}});return m(c,a)};return i(a)}function j(){if(k()){j=Reflect.construct}else{j=function(b,c,d){var e=[null];e.push.apply(e,c);var a=Function.bind.apply(b,e),f=new a;if(d)m(f,d.prototype);return f}}return j.apply(null,arguments)}function k(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return!0}catch(a){return!1}}function l(a){return-1!==Function.toString.call(a).indexOf("[native code]")}function m(a,b){m=Object.setPrototypeOf||function(a,b){a.__proto__=b;return a};return m(a,b)}function n(a){n=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)};return n(a)}function o(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function p(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function q(a,b,c){if(b)p(a.prototype,b);if(c)p(a,c);return a}var r=function(){function a(b,c){var d=this;o(this,a);this.dispatchEvent=b;this.target=null!==c&&void 0!==c?c:document;this.readonly=!1;this.eventstopublish=[];this.initialPromise=new Promise(function(a){d.target.addEventListener("state:loaded",function initialStateDone(b){a(b.detail.state)})})}q(a,[{key:"setInitialState",value:function setInitialState(a){if(this.state!==void 0){throw Error("Initial state can only be initialized ones")}var b=new Proxy({},new s("state",this,!0));for(var c in a){if(a.hasOwnProperty(c)){b[c]=a[c]}}this.state=b;this.readonly=!0;this.dispatchEvent({action:"state:loaded",state:this.state},this.target)}},{key:"getInitialPromise",value:function getInitialPromise(){return this.initialPromise}},{key:"setReadOnly",value:function setReadOnly(a){this.readonly=a;if(this.readonly){this._publishEvents()}}},{key:"processUpdates",value:function processUpdates(a){var b=this;if(!Array.isArray(a)){throw Error("State updates must be an array")}this.setReadOnly(!1);a.forEach(function(a){if(a.name===void 0){throw Error("Missing state update name")}b.processUpdate(a.name,a.action,a.fields)});this.setReadOnly(!0)}},{key:"processUpdate",value:function processUpdate(a,b,c){var d=this.state;if(!c){throw Error("Missing state update fields")}if("create"==b){if(d[a]instanceof t){d[a].add(c);return}d[a]=c;return}var e=d[a];if(e instanceof t){if(c.id===void 0){throw Error("Missing id for ".concat(a," state update"))}e=d[a].get(c.id);if(!e){throw Error("Inexistent ".concat(a," ").concat(c.id))}}this.readonly=!1;if("delete"==b){if(d[a]instanceof t){d[a].delete(c.id);return}delete d[a];return}if("update"==b||b===void 0){for(var f in c){if(c.hasOwnProperty(f)){e[f]=c[f]}}}}},{key:"registerStateAction",value:function registerStateAction(a,b,c,d){var e="updated";if(null!==b){this.eventstopublish.push({eventname:"".concat(a,".").concat(b,":").concat(c),eventdata:d,action:c})}else{e=c}if(d.id!==void 0){if(null!==b){this.eventstopublish.push({eventname:"".concat(a,"[").concat(d.id,"].").concat(b,":").concat(c),eventdata:d,action:c})}this.eventstopublish.push({eventname:"".concat(a,"[").concat(d.id,"]:").concat(e),eventdata:d,action:e})}this.eventstopublish.push({eventname:"".concat(a,":").concat(e),eventdata:d,action:e});this.eventstopublish.push({eventname:"state:updated",eventdata:d,action:"updated"})}},{key:"_publishEvents",value:function _publishEvents(){var a=this,b=this.eventstopublish;this.eventstopublish=[];b.sort(function(c,a){var b,d,e={created:0,updated:1,deleted:2},f=null!==(b=e[c.action])&&void 0!==b?b:0,g=null!==(d=e[a.action])&&void 0!==d?d:0;if(f===g){return c.eventname.length-a.eventname.length}return f-g});var c=new Set;b.forEach(function(b){var d,e="".concat(b.eventname,".").concat(null!==(d=b.eventdata.id)&&void 0!==d?d:0);if(!c.has(e)){a.dispatchEvent({action:b.eventname,state:a.state,element:b.eventdata},a.target);c.add(e)}})}}]);return a}();a.default=r;var s=function(){function a(b,c,d){o(this,a);this.name=b;this.statemanager=c;this.proxyvalues=null!==d&&void 0!==d?d:!1}q(a,[{key:"set",value:function set(b,c,d,e){if(this.statemanager.readonly){throw new Error("State locked. Use mutations to change ".concat(c," value in ").concat(this.name,"."))}if(JSON.stringify(b[c])===JSON.stringify(d)){return!0}var f=b[c]!==void 0?"updated":"created";if(this.proxyvalues){if(Array.isArray(d)){b[c]=new t(c,this.statemanager).loadValues(d)}else{b[c]=new Proxy(d,new a(c,this.statemanager))}}else{b[c]=d}if(this.statemanager.state===void 0){return!0}this.statemanager.registerStateAction(this.name,c,f,e);return!0}},{key:"deleteProperty",value:function deleteProperty(a,b){if(this.statemanager.readonly){throw new Error("State locked. Use mutations to delete ".concat(b," in ").concat(this.name,"."))}if(b in a){delete a[b];this.statemanager.registerStateAction(this.name,b,"deleted",a)}return!0}}]);return a}(),t=function(a){e(d,a);var g=f(d);function d(a,b,c){var e;o(this,d);e=g.call(this,c);e.name=a;e.statemanager=b;return e}q(d,[{key:"set",value:function set(a,b){if(this.statemanager.readonly){throw new Error("State locked. Use mutations to change ".concat(a," value in ").concat(this.name,"."))}a=this.normalizeKey(a);this.checkValue(b);if(a===void 0||null===a){throw Error("State lists keys cannot be null or undefined")}if(b.id!==a){throw new Error("State error: ".concat(this.name," list element ID (").concat(b.id,") and key (").concat(a,") mismatch"))}var e=c(n(d.prototype),"has",this).call(this,a)?"updated":"created",f=c(n(d.prototype),"set",this).call(this,a,new Proxy(b,new s(this.name,this.statemanager)));if(this.statemanager.state===void 0){return f}this.statemanager.registerStateAction(this.name,null,e,c(n(d.prototype),"get",this).call(this,a));return f}},{key:"checkValue",value:function checkValue(a){if("object"===!b(a)&&null!==a){throw Error("State lists can contain objects only")}if(a.id===void 0){throw Error("State lists elements must contain at least an id attribute")}}},{key:"normalizeKey",value:function normalizeKey(a){return(a+"").valueOf()}},{key:"add",value:function add(a){this.checkValue(a);return this.set(a.id,a)}},{key:"get",value:function get(a){return c(n(d.prototype),"get",this).call(this,this.normalizeKey(a))}},{key:"has",value:function has(a){return c(n(d.prototype),"has",this).call(this,this.normalizeKey(a))}},{key:"delete",value:function _delete(a){a=this.normalizeKey(a);if(this.statemanager.readonly){throw new Error("State locked. Use mutations to change ".concat(a," value in ").concat(this.name,"."))}var b=c(n(d.prototype),"get",this).call(this,a),e=c(n(d.prototype),"delete",this).call(this,a);if(!e){return e}this.statemanager.registerStateAction(this.name,null,"deleted",b);return e}},{key:"toJSON",value:function toJSON(){var a=[];this.forEach(function(b){a.push(b)});return a}},{key:"loadValues",value:function loadValues(a){var b=this;a.forEach(function(a){b.checkValue(a);var c=a.id,d=new Proxy(a,new s(b.name,b.statemanager));b.set(c,d)});return this}}]);return d}(i(Map));return a.default});
//# sourceMappingURL=statemanager.min.js.map
