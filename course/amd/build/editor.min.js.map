{"version":3,"sources":["../src/editor.js"],"names":["mutations","statemanager","components","Set","watchers","Map","init","courseid","defaultmutations","document","addEventListener","events","statechanged","callWatchersHandler","ajax","call","methodname","args","jsonstate","statedata","JSON","parse","StateManager","dispatchStateChangedEvent","setInitialState","log","error","action","state","element","dispatchEvent","CustomEvent","bubbles","detail","event","has","get","forEach","watcher","debug","name","handler","notifyError","message","getState","dispatch","actionname","arguments","mutationfunction","apply","registerComponent","component","watch","getEventHandlers","key","hasOwnProperty","actionwathers","push","set","add","state_loaded","setMutations","manager"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main course editor module\n *\n * @module     core_course/editor\n * @package    core_course\n * @copyright  2021 Ferran Recio <ferran@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport log from 'core/log';\nimport defaultmutations from 'core_course/local/editor/mutations';\nimport StateManager from 'core_course/local/editor/statemanager';\nimport ajax from 'core/ajax';\nimport events from 'core_course/events';\n\nlet mutations;\nlet statemanager;\nlet components = new Set([]);\nlet watchers = new Map([]);\n\n/**\n* Set up the course editor when the page is ready.\n*\n* @method init\n* @param {int} courseid course id\n*/\nasync function init(courseid) {\n\n    // Mutations can be overridden by the format plugin\n    // but we need the default one at least.\n    mutations = defaultmutations;\n\n    // Register as event listener.\n    document.addEventListener(events.statechanged, callWatchersHandler);\n\n    try {\n        // Async load the initial state.\n        const jsonstate = await ajax.call([{\n            methodname: 'core_course_get_state',\n            args: {courseid}\n        }])[0];\n        const statedata = JSON.parse(jsonstate);\n        statemanager = new StateManager(dispatchStateChangedEvent);\n        statemanager.setInitialState(statedata);\n    } catch (error) {\n        log.error(\"EXCEPTION RAISED WHILE INIT COURSE EDITOR\");\n        log.error(error);\n    }\n}\n\n/**\n * This function will be moved to core_course/events module\n * when the file is migrated to the new JS events structure proposed in MDL-70990.\n *\n * @method dispatchStateChangedEvent\n * @param {string} action the action done\n * @param {object} state the full state\n * @param {object} element the modified element\n */\nfunction dispatchStateChangedEvent(action, state, element) {\n    // Dispatch a custom event in case any component wants to listen.\n    document.dispatchEvent(new CustomEvent(events.statechanged, {\n        bubbles: true,\n        detail: {action, state, element},\n    }));\n}\n\n/**\n * State changed listener.\n *\n * This function take any change in the course state and send it to the proper\n * watchers. Each component is free to register as state change listener,\n * but we use a regular loop to avoid redundant code in all components\n * and prevent unnecessary browser memory usage.\n *\n * @param {CustomEvent} event\n */\nfunction callWatchersHandler(event) {\n    const action = event.detail.action;\n    // Execute any registered component watchers.\n    if (watchers.has(action)) {\n        watchers.get(action).forEach((watcher) => {\n            try {\n                log.debug(`Executing \"${watcher.name}\" ${action} watcher`);\n                watcher.handler(event.detail);\n            } catch (error) {\n                log.error(`Component \"${watcher.name}\" error while watching ${action}`);\n                log.error(error);\n            }\n        });\n    }\n}\n\n/**\n* Set up the mutation manager.\n*\n* @method setMutations\n* @param {Object} manager the new mutation manager\n*/\nfunction setMutations(manager) {\n    mutations = manager;\n}\n\n/**\n* Notify a communication error during a mutation.\n*\n* @method notifyError\n* @param {string} message the error message\n*/\nfunction notifyError(message) {\n    // Not done yet.\n    log.error(message);\n}\n\n/**\n* Return the current state\n*\n* @method getState\n* @return {object}\n*/\nfunction getState() {\n    return statemanager.state;\n}\n\n/**\n* Dispatch a change in the state.\n*\n* @method dispatch\n* @param {string} actionname the action name (usually the mutation name)\n* @param {Object} data the mutation data\n*/\nfunction dispatch() {\n    let actionname, args;\n    [actionname, ...args] = arguments;\n    try {\n        const mutationfunction = mutations[actionname] ?? defaultmutations[actionname];\n        mutationfunction.apply(mutations, [statemanager, ...args]);\n    } catch (error) {\n        log.error(error);\n    }\n}\n\n/**\n* Register a new component.\n*\n* @method registerComponent\n* @param {Object} component the new component\n*/\nfunction registerComponent(component) {\n    // Register watchers.\n    const watch = component.getEventHandlers();\n    for (let key in watch) {\n        if (watch.hasOwnProperty(key)) {\n            let actionwathers = watchers.get(key) ?? [];\n            actionwathers.push({\n                name: component.name ?? 'Unkown component',\n                handler: watch[key],\n            });\n            watchers.set(key, actionwathers);\n        }\n    }\n    components.add(component);\n    // There's the possibility a component is registered after the initial state\n    // is loaded. For those cases the subcription to state_loaded\n    // will not work so we execute this state manually.\n    if (statemanager !== undefined && statemanager.state !== undefined) {\n        if (watch.state_loaded !== undefined) {\n            watch.state_loaded({state: statemanager.state});\n        }\n    }\n}\n\nexport default {\n    init,\n    setMutations,\n    notifyError,\n    getState,\n    dispatch,\n    registerComponent,\n};\n"],"file":"editor.min.js"}