{"version":3,"sources":["../../../src/local/editor/statemanager.js"],"names":["StateManager","dispatchevent","dispatchEvent","locked","initialstate","state","prop","hasOwnProperty","Array","isArray","Map","forEach","data","set","id","Proxy","handler","lockvalue","updates","update","processUpdate","name","action","fields","updatename","proxied","add","log","error","current","get","delete","eventstopublish","publishEvents","statemanager","fieldChanges","publishedevents","Set","event","eventkey","eventname","eventdata","has","debug","$name","$statemanager","obj","value","Error","JSON","stringify","push","deleteProperty"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Default state manager\n *\n * @module     core_course/editor/statemanager\n * @package    core_course\n * @copyright  2021 Ferran Recio <ferran@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport log from 'core/log';\nimport {debounce} from 'core/utils';\n\n/**\n* Set up general reactive class.\n*\n* The reactive class is responsible for contining the main store,\n* the complete components list that can be used and initialize the main\n* component.\n*\n* @return {void}\n*/\nconst StateManager = class {\n\n    /**\n     * Create a basic reactive state store.\n     *\n     * @param {function} dispatchevent the function to dispatch the custom event when the state changes.\n     */\n    constructor(dispatchevent) {\n        this.dispatchEvent = dispatchevent;\n        this.locked = false;\n    }\n\n    /**\n     * Loads the initial state.\n     *\n     * Note this method will trigger a state changed event with \"state_loaded\" actionname.\n     *\n     * The state will be locked authomatically when the state is loaded.\n     *\n     * @param {object} initialstate\n     */\n    setInitialState(initialstate) {\n\n        let state = {};\n        for (const prop in initialstate) {\n            if (initialstate.hasOwnProperty(prop)) {\n                // Check is is an array.\n                if (Array.isArray(initialstate[prop])) {\n                    state[prop] = new Map();\n                    initialstate[prop].forEach((data) => {\n                        state[prop].set(data.id ?? 0, new Proxy(data, handler(prop, this)));\n                    });\n                } else {\n                    state[prop] = new Proxy(initialstate[prop], handler(prop, this));\n                }\n            }\n        }\n        // Create the state object.\n        this.state = new Proxy(state, handler('', this));\n        // When the state is loaded we can lock it to prevent illegal changes.\n        this.locked = true;\n        this.dispatchEvent('state_loaded', this.state);\n    }\n\n    /**\n     * Locks or unlocks the state to prevent illegal updates.\n     *\n     * @param {bool} lockvalue\n     */\n    setLocked(lockvalue) {\n        this.locked = lockvalue;\n    }\n\n    /**\n     * Process a state updates array and do all the necessary changes.\n     *\n     * Note this method unlocks the state while it is executing and relocks it\n     * when finishes.\n     *\n     * @param {array} updates\n     * @returns {bool}\n     */\n    processUpdates(updates) {\n        this.locked = false;\n        for (let update of updates) {\n            this.processUpdate(update.name, update.action, update.fields);\n        }\n        this.locked = true;\n        return true;\n    }\n\n    /**\n     * Private function process a single state updates.\n     *\n     * Note this method unlocks the state while it is executing and relocks it\n     * when finishes.\n     *\n     * @param {string} updatename\n     * @param {string} action\n     * @param {object} fields\n     */\n    processUpdate(updatename, action, fields) {\n        let state = this.state;\n        // Process cm creation.\n        if (action == 'create') {\n            // Create can be applied only to lists, not to objects.\n            if (state[updatename] instanceof Map) {\n                let proxied = new Proxy(fields, handler(updatename, this));\n                state[updatename].add(fields.id ?? 0, proxied);\n                this.dispatchEvent(`${updatename}_created`, state, proxied);\n                return;\n            }\n            // TODO: add attribute creation suport (not needed for the proof of concept).\n            log.error(`Cannot execute create on ${updatename}`);\n            return;\n        }\n\n        // Get the current value.\n        let current = state[updatename];\n        if (current instanceof Map) {\n            current = state[updatename].get(fields.id ?? 0);\n            if (!current) {\n                log.error(`Inexistent ${updatename} ${fields.id ?? 0}`);\n                return;\n            }\n        }\n\n        // Process cm deletion.\n        if (action == 'delete') {\n            if (state[updatename] instanceof Map) {\n                state[updatename].delete(fields.id ?? 0);\n                this.dispatchEvent(`${updatename}_deleted`, state, current);\n                return;\n            }\n            delete state[updatename];\n            return;\n        }\n\n        // Execute updates.\n        for (const prop in fields) {\n            if (fields.hasOwnProperty(prop)) {\n                current[prop] = fields[prop];\n            }\n        }\n    }\n};\n\nexport default StateManager;\n\n// Proxy helpers.\n\n// This array contains the events that are not yet dispatched.\nlet eventstopublish = [];\n\n/**\n * Dispatch all the pending events.\n *\n * This is a debounced function to prevent repeated updates.\n *\n * @param {*} state the affected current state.\n */\nconst publishEvents = debounce((statemanager) => {\n    const fieldChanges = eventstopublish;\n    eventstopublish = [];\n\n    // List of the published events to prevent redundancies.\n    let publishedevents = new Set();\n\n    fieldChanges.forEach(function(event) {\n\n        const eventkey = `${event.eventname}.${event.eventdata.id ?? 0}`;\n\n        if (!publishedevents.has(eventkey)) {\n            log.debug(`EVENT ${event.eventname}`);\n            statemanager.dispatchEvent(event.eventname, statemanager.state, event.eventdata);\n            // PubSub.publish(event.eventname, {state, element: event.eventdata});\n            publishedevents.add(eventkey);\n        }\n    });\n}, 10);\n\n\n/**\n * The proxy handler class.\n *\n * This proxy will trigger two events everytime an attribute is modified:\n * one for the specific attribute and one for the variable.\n *\n * @param {*} name\n * @param {*} statemanager\n * @returns {object}\n */\nconst handler = function(name, statemanager) {\n    return {\n        $name: name,\n        $statemanager: statemanager,\n        set: function(obj, prop, value) {\n            // Only mutations should be able to set state values.\n            if (this.$statemanager.locked) {\n                throw new Error(`State locked. Use mutations to change ${prop} value.`);\n            }\n\n            if (JSON.stringify(obj[prop]) === JSON.stringify(value)) {\n                return true;\n            }\n\n            obj[prop] = value;\n\n            eventstopublish.push({\n                eventname: `${this.$name}_${prop}_updated`,\n                eventdata: obj,\n            });\n\n            // Register the general change.\n            eventstopublish.push({\n                eventname: `${this.$name}_updated`,\n                eventdata: obj,\n            });\n\n            publishEvents(this.$statemanager);\n            return true;\n        },\n        deleteProperty: function(obj, prop) {\n            // Only mutations should be able to set state values.\n            if (this.$statemanager.locked) {\n                throw new Error(`State locked. Use mutations to delete ${prop}.`);\n            }\n            if (prop in obj) {\n\n                delete obj[prop];\n\n                eventstopublish.push({\n                    eventname: `${this.$name}_${prop}_deleted`,\n                    eventdata: obj,\n                });\n\n                // Register the general change.\n                eventstopublish.push({\n                    eventname: `${this.$name}_updated`,\n                    eventdata: obj,\n                });\n            }\n            return true;\n        },\n    };\n};\n"],"file":"statemanager.min.js"}