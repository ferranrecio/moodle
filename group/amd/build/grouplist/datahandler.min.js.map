{"version":3,"sources":["../../src/grouplist/datahandler.js"],"names":["listeners","get","target","prop","data","methods","set","value","computed","TypeError","recalculate","dirty","newvalue","bind","Proxy","oldvalue","addListener","receiver","Set","add","proxyComponent","component","ReactiveData","result","getInternalPath","path","startsWith","absolutepathchar","$id","replace","getRootStores","reactiveStorages","nextindex","generateStorageId","node","alias","registerid","$alias","item","deepproxy","Object","entries","forEach","key","fakenode","primitiveWrap","newid","obj","newalias","reduce","news","current","filter","has","map","reactive","emitChange","create","$value","valueOf","toString"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Default reactive data handler.\n *\n * @module     core_group/grouplist/store\n * @package    core_course\n * @copyright  2020 Ferran Recio <ferran@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// import log from 'core/log';\nimport reactive from 'core_group/grouplist/reactive';\n\n\nexport default {\n\n    /** Object of data listeners indexed by property. */\n    listeners: {},\n\n    get: function(target, prop) {\n        if (target.data[prop] !== undefined) {\n            // this.addListener(prop, receiver);\n            return target.data[prop];\n        }\n        if (target.methods[prop] !== undefined) {\n            return target.methods[prop]();\n        }\n        return target[prop];\n    },\n\n    set: function(target, prop, value) {\n\n        // this.init(target);\n\n        if (target.computed[prop] != undefined) {\n            throw new TypeError('Calculated attributes cannot be set yet.');\n        }\n\n        if (target.data[prop] !== undefined) {\n            target.data[prop] = value;\n        }\n        target[prop] = value;\n\n        return true;\n    },\n    // Not for now and possibly never.\n    recalculate(target, prop) {\n        if (target.computed[prop] !== undefined && (target.dirty[prop] !== undefined || target.data[prop] === undefined)) {\n            // This line seems complicated but it is not. Computed attributes require to access\n            // the same proxied variables than the rest of the methods but this is not possible because\n            // we are currently calculating most of the data. Instead, we use a new proxied object.\n            const newvalue = target.computed[prop].bind(new Proxy(target, this))();\n            const oldvalue = target.data[prop];\n            if (newvalue !== oldvalue) {\n                target.data[prop] = newvalue;\n            }\n            if (target.dirty[prop] !== undefined) {\n                delete target.dirty[prop];\n            }\n            return target.data[prop];\n        }\n        return;\n    },\n\n    addListener(prop, receiver) {\n        if (receiver === this) {\n            return;\n        }\n        if (this.listeners[prop] == undefined) {\n            this.listeners[prop] = new Set();\n        }\n        this.listeners[prop].add(receiver);\n    },\n\n    proxyComponent(component) {\n        // If we have no parent means it will generate a new root node ID.\n        const data = ReactiveData(component.data);\n        component.data = data;\n        const result = new Proxy(component, this);\n        return result;\n    },\n\n    // Translate a string path into an internal path, if necessary\n    getInternalPath(path, data) {\n        // Check we are in the right root node.\n        if (path.startsWith(absolutepathchar) && !path.startsWith(data.$id)) {\n            throw new TypeError(`Path ${path} is not from storage ${data.$id}.`);\n        }\n        path = path.replace(`${data.$id}.`, '');\n        return path;\n    },\n\n    // Get all root storages.\n    getRootStores() {\n        return reactiveStorages;\n    },\n};\n\nlet nextindex = 0;\nlet absolutepathchar = '@';\n\nlet reactiveStorages = {};\n\nconst generateStorageId = function() {\n    nextindex++;\n    return `${absolutepathchar}${nextindex}`;\n};\n\nconst ReactiveData = function(node, alias) {\n    // If we have no parent means it will generate a new root node ID.\n    let registerid = null;\n    if (alias === undefined) {\n        registerid = generateStorageId();\n        alias = new Set([registerid]);\n    }\n    // If the node is already a reactive node, we just add the new alias.\n    if (node.$alias !== undefined) {\n        node.$alias = new Set([...node.$alias, ...alias]);\n        return node;\n    }\n\n    // Create new reactive node.\n    let item;\n    if (typeof node === 'object' && node !== null) {\n        item = new Proxy(node, deepproxy(alias, registerid));\n        Object.entries(node).forEach(([key, value]) => {\n            item[key] = value;\n        });\n    } else {\n        // Proxies cannot store primitives so we need to convert into an object.\n        // For primitive values, we need to do thing differently :-(\n        // TODO: try to figure out how to fake primitives properly.\n        const fakenode = primitiveWrap(node);\n        item = new Proxy(fakenode, deepproxy(alias, registerid));\n    }\n    // Only root nodes has register id.\n    if (registerid !== null) {\n        reactiveStorages[registerid] = item;\n    }\n    return item;\n};\n\n// VersiÃ³ amb fullpaths\n/**\n * Proxy handler to trap get and set on data and emit change events.\n */\nconst deepproxy = function (alias, registerid) {\n    const newid = registerid ?? null;\n    return {\n        $alias: alias,\n        $id: newid,\n        // $parent: parent,\n        // $sons: {},\n        get: function (obj, prop) {\n            if (prop == '$alias') {\n                return this.$alias;\n            }\n            if (prop == '$id') {\n                return this.$id;\n            }\n            return obj[prop];\n        },\n        set: function (obj, prop, value) {\n            if (prop == '$alias') {\n                this.$alias = value;\n                // We don't need to emit any change here because this order came from\n                // one of the parents who will do the proper emit.\n                return true;\n            }\n            let newalias;\n            if (obj[prop] !== value) {\n                // Generate list of new object alias.\n                newalias = [...this.$alias].reduce((news, current) => news.add(`${current}.${prop}`), new Set());\n                // Dettach old node alias.\n                if (obj[prop] !== undefined && obj[prop].$alias !== undefined) {\n                    obj[prop].$alias = new Set([...obj[prop].$alias].filter(alias => !newalias.has(alias)));\n                }\n            } else {\n                // This is already the same node and we don't need to modify any alias.\n                newalias = new Set();\n            }\n            // Apply new alias to node and create reactive node if necessary.\n            obj[prop] = ReactiveData(value, newalias);\n            // Emit changes.\n            [...newalias].map( path => reactive.emitChange(path, 'update'));\n\n            return true;\n        },\n    };\n};\n\nconst primitiveWrap = function(node) {\n    const wrapper = {};\n    let fakenode = Object.create(wrapper);\n    fakenode.$value = node;\n    fakenode.valueOf = function() {\n      return this.$value;\n    }.bind(fakenode);\n    fakenode.toString = function() {\n      return '' + this.$value;\n    }.bind(fakenode);\n    return fakenode;\n};\n"],"file":"datahandler.min.js"}